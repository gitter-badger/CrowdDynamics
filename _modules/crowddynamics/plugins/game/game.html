

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>crowddynamics.plugins.game.game &mdash; Crowd Dynamics 1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../search.html"/>
    <link rel="top" title="Crowd Dynamics 1 documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> Crowd Dynamics
          

          
            
            <img src="../../../../_static/logo.svg" class="logo" />
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">First Steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../installation.html#conda">Conda</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../installation.html#from-source">From Source</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../usage.html#basic-architecture">Basic Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../usage.html#command-line-interface">Command-line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../usage.html#configuration">Configuration</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Simulation Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../multiagent/index.html">Multi-Agent</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../multiagent/social_force_model.html">Social Force Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../multiagent/motion.html">Motion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../multiagent/interactions.html">Interactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../multiagent/steering.html">Steering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../multiagent/integrator.html">Integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../multiagent/multiagent.html">Multi-Agent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../multiagent/multiagent.html#module-crowddynamics.multiagent">Classes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../multiagent/multiagent.html#module-crowddynamics.multiagent.testing">Simulations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cellular/index.html">Cellular Automata</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../continuum/index.html">Continuum Flow</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/index.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/vector2D.html">Vector2D</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/io.html">IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/sampling.html">Sampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/cli.html">Command-line Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/gui.html">Graphical User Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/game.html">Plugins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../api/game.html#module-crowddynamics.plugins.game">Game</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../api/testing.html">Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tables.html">Tables</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../tables.html#agent-properties">Agent Properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../tables.html#body-types">Body Types</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Theory</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../research/index.html">Research</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../research/phenomena.html">Phenomena</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../research/phenomena.html#egress-congestion">Egress Congestion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../research/phenomena.html#faster-is-slower">Faster is slower</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../research/phenomena.html#arching">Arching</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../research/phenomena.html#zipper-effect">Zipper effect</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../research/phenomena.html#herding">Herding</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../research/phenomena.html#lane-formation">Lane formation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../research/phenomena.html#freezing-by-heat">Freezing by heat</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../research/phenomena.html#turbulence">Turbulence</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../research/phenomena.html#stop-and-go-waves">Stop-and-Go waves</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../research/phenomena.html#braess-s-paradox">Braess&#8217;s paradox</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../research/applications.html">Applications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../foundations/index.html">Foundations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../foundations/theory.html">Mathematical Foundations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../foundations/theory.html#time">Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../foundations/theory.html#geometry">Geometry</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../foundations/theory.html#domain">Domain</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../foundations/theory.html#obstacle">Obstacle</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../foundations/theory.html#exit">Exit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../foundations/theory.html#narrow-bottleneck">Narrow bottleneck</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../foundations/theory.html#agent">Agent</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../foundations/theory.html#model">Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../foundations/theory.html#circular-model">Circular model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../foundations/theory.html#elliptical-model">Elliptical model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../foundations/theory.html#three-circle-model">Three circle model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../foundations/theory.html#initial-configuration">Initial configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../foundations/quantities.html">Quantities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../foundations/quantities.html#density">Density</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../foundations/quantities.html#flow">Flow</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../foundations/quantities.html#rate">Rate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../foundations/quantities.html#types">Types</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../foundations/quantities.html#pressure">Pressure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../foundations/quantities.html#fundamental-diagram">Fundamental Diagram</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">Crowd Dynamics</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      
    <li>crowddynamics.plugins.game.game</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for crowddynamics.plugins.game.game</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numba</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib.path</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="k">import</span> <span class="n">Polygon</span>

<span class="kn">from</span> <span class="nn">crowddynamics.core.vector2D.vector2D</span> <span class="k">import</span> <span class="n">length_nx2</span><span class="p">,</span> <span class="n">length</span>
<span class="kn">from</span> <span class="nn">crowddynamics.task_graph</span> <span class="k">import</span> <span class="n">TaskNode</span>


<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="poisson_clock"><a class="viewcode-back" href="../../../../api/game.html#crowddynamics.plugins.game.poisson_clock">[docs]</a><span class="k">def</span> <span class="nf">poisson_clock</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Poisson process that simulates when agents will change their strategies.</span>
<span class="sd">    Time between updates are independent random variables defined</span>

<span class="sd">    .. math::</span>

<span class="sd">       \tau_i \sim \operatorname{Exp}(\lambda)</span>

<span class="sd">    Where the ``rate`` parameter is</span>

<span class="sd">    .. math::</span>

<span class="sd">       \operatorname{E}(\tau) = \frac{1}{\lambda} = interval</span>

<span class="sd">    Times when agent updates its strategy</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">       \begin{split}\begin{cases}</span>
<span class="sd">       T_n = \tau_1 + \ldots + \tau_n, &amp; n \geq 1 \\</span>
<span class="sd">       T_0 = 0</span>
<span class="sd">       \end{cases}\end{split}</span>

<span class="sd">    Sequence of update times</span>

<span class="sd">    .. math::</span>

<span class="sd">       \{T_1, T_2, T_3, \ldots, T_n\}, \quad T_n &lt; \Delta t</span>

<span class="sd">    Number of arrivals by the :math:`s`</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">       N(s) &amp;= \max\{n : T_n \leq s\} \\</span>
<span class="sd">       N(s) &amp;\sim \operatorname{Poi}(\lambda)</span>

<span class="sd">    Args:</span>
<span class="sd">        interval (float):</span>
<span class="sd">            Expected frequency of update.</span>

<span class="sd">        dt (float):</span>
<span class="sd">            Discrete timestep :math:`\Delta t` aka time window.</span>

<span class="sd">    Yields:</span>
<span class="sd">        float:</span>
<span class="sd">            Moments in the time window when the strategies should be updated.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Numpy exponential distribution&#39;s scale parameter is equal to</span>
    <span class="c1"># 1/lambda which is why we can supply interval directly into the</span>
    <span class="c1"># np.random.exponential.</span>
    <span class="n">t_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">t_tot</span> <span class="o">&lt;</span> <span class="n">dt</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">t_tot</span>
        <span class="n">t_tot</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span></div>


<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="poisson_timings"><a class="viewcode-back" href="../../../../api/game.html#crowddynamics.plugins.game.poisson_timings">[docs]</a><span class="k">def</span> <span class="nf">poisson_timings</span><span class="p">(</span><span class="n">players</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Update times for all agent in the game using Poisson clock.</span>

<span class="sd">    Args:</span>
<span class="sd">        players (numpy.ndarray):</span>
<span class="sd">            Indices of the players.</span>

<span class="sd">        interval (float):</span>
<span class="sd">        dt (float):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: List of indices of agents sorted by their update times.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute update times for all agents.</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># TODO: check shuffle doesn&#39;t cause any side effects</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">players</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">players</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">poisson_clock</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
            <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># Sort the indices by the update times</span>
    <span class="c1"># noinspection PyTypeChecker</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
        <span class="k">yield</span> <span class="n">indices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></div>


<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="payoff"><a class="viewcode-back" href="../../../../api/game.html#crowddynamics.plugins.game.payoff">[docs]</a><span class="k">def</span> <span class="nf">payoff</span><span class="p">(</span><span class="n">s_i</span><span class="p">,</span> <span class="n">s_j</span><span class="p">,</span> <span class="n">t_aset</span><span class="p">,</span> <span class="n">t_evac_i</span><span class="p">,</span> <span class="n">t_evac_j</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Payoff matrix of the game.</span>

<span class="sd">    Args:</span>
<span class="sd">        s_i (int): Our strategy</span>
<span class="sd">        s_j (int): Neighbor strategy</span>
<span class="sd">        t_aset (float): Available safe egress time.</span>
<span class="sd">        t_evac_i (float): Time to evacuate for agent i.</span>
<span class="sd">        t_evac_j (float): Time to evacuate for agent j.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">s_j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">average</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_evac_i</span> <span class="o">+</span> <span class="n">t_evac_j</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">average</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">return</span> <span class="n">t_aset</span> <span class="o">/</span> <span class="n">average</span>
        <span class="k">elif</span> <span class="n">s_i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">s_j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">s_i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not valid strategy.&quot;</span><span class="p">)</span></div>


<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="agent_closer_to_exit"><a class="viewcode-back" href="../../../../api/game.html#crowddynamics.plugins.game.agent_closer_to_exit">[docs]</a><span class="k">def</span> <span class="nf">agent_closer_to_exit</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Agent closer to exit</span>

<span class="sd">    Function mapping players to number of agents that are closer to the exit is denoted</span>

<span class="sd">    .. math::</span>
<span class="sd">       \lambda : P \mapsto [0, | P | - 1].</span>

<span class="sd">    Ordering is defined as the distances between the exit and an agent</span>

<span class="sd">    .. math::</span>
<span class="sd">       d(\mathcal{E}_i, \mathbf{x}_{i})</span>

<span class="sd">    where</span>

<span class="sd">    - :math:`\mathcal{E}_i` is the exit the agent is trying to reach</span>
<span class="sd">    - :math:`\mathbf{x}_{i}` is the center of the mass of an agent</span>

<span class="sd">    For narrow bottlenecks we can approximate the distance</span>

<span class="sd">    .. math::</span>
<span class="sd">       d(\mathcal{E}_i, \mathbf{x}_{i}) \approx \| \mathbf{c} - \mathbf{x}_{i} \|</span>

<span class="sd">    where</span>

<span class="sd">    - :math:`\| \cdot \|` is euclidean `metric`_</span>
<span class="sd">    - :math:`\mathbf{c}` is the center of the exit.</span>

<span class="sd">    .. _metric: https://en.wikipedia.org/wiki/Metric_(mathematics)</span>

<span class="sd">    .. Then we sort the distances by indices to get the order of agent indices from closest to the exit door to farthest, sorting by indices again gives us number of agents closer to the exit door</span>

<span class="sd">    Algorithm</span>

<span class="sd">    #) Sort by distances to map number of closer agents to player</span>

<span class="sd">       .. math::</span>
<span class="sd">           \boldsymbol{\lambda}^{-1} = \underset{i \in P}{\operatorname{arg\,sort}} \left( d(\mathcal{E}_i, \mathbf{x}_{i}) \right)</span>

<span class="sd">    #) Sort by players to map player to number of closer agents</span>

<span class="sd">    .. math::</span>
<span class="sd">       \boldsymbol{\lambda} = \operatorname{arg\,sort} (\boldsymbol{\lambda}^{-1})</span>


<span class="sd">    Args:</span>
<span class="sd">        points (numpy.ndarray):</span>
<span class="sd">            Array [[x1, y2], [x2, y2]]</span>

<span class="sd">        position (numpy.ndarray):</span>
<span class="sd">            Positions of the agents.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray:</span>
<span class="sd">            Array where indices denote agents and value how many agents are</span>
<span class="sd">            closer to the exit.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">length_nx2</span><span class="p">(</span><span class="n">mid</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span>
    <span class="c1"># players[values] = agents, indices = number of agents closer to exit</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="c1"># values = number of agents closer to exit, players[indices] = agents</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num</span></div>


<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="exit_capacity"><a class="viewcode-back" href="../../../../api/game.html#crowddynamics.plugins.game.exit_capacity">[docs]</a><span class="k">def</span> <span class="nf">exit_capacity</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">agent_radius</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Estimation of the capacity of narrow exit. Narrow exit is defined max</span>
<span class="sd">    :math:`3\,\mathrm{m}` wide.</span>

<span class="sd">    Args:</span>
<span class="sd">        points (numpy.ndarray):</span>
<span class="sd">        agent_radius (float):</span>

<span class="sd">    Returns:</span>
<span class="sd">        float:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">length</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">agent_radius</span><span class="p">)</span></div>


<span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<div class="viewcode-block" id="best_response_strategy"><a class="viewcode-back" href="../../../../api/game.html#crowddynamics.plugins.game.best_response_strategy">[docs]</a><span class="k">def</span> <span class="nf">best_response_strategy</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">players</span><span class="p">,</span> <span class="n">door</span><span class="p">,</span> <span class="n">radius_max</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span>
                           <span class="n">strategies</span><span class="p">,</span> <span class="n">t_aset</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    New strategy is selected using best response dynamics which finds the</span>
<span class="sd">    strategy that minimizes loss using the payoff function</span>

<span class="sd">    .. math::</span>
<span class="sd">       s_{i} = \underset{s \in S}{\arg \min} \sum_{j \in N_{i}^{neigh}} f(s, s_{j})</span>

<span class="sd">    where</span>

<span class="sd">    - :math:`N_{i}^{neigh} \subset P \setminus \{P_{i}\}` set is eight closes</span>
<span class="sd">      agents excluding the agent itself at maximum skin-to-skin distance of</span>
<span class="sd">      :math:`0.40 \ \mathrm{m}` from agent :math:`i`.</span>

<span class="sd">    Args:</span>
<span class="sd">        agent:</span>
<span class="sd">        players:</span>
<span class="sd">        door:</span>
<span class="sd">        radius_max:</span>
<span class="sd">        strategy:</span>
<span class="sd">        strategies:</span>
<span class="sd">        t_aset:</span>
<span class="sd">        interval:</span>
<span class="sd">        dt:</span>

<span class="sd">    Returns:</span>
<span class="sd">        None:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">players</span><span class="p">]</span>
    <span class="n">t_evac</span> <span class="o">=</span> <span class="n">agent_closer_to_exit</span><span class="p">(</span><span class="n">door</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">exit_capacity</span><span class="p">(</span><span class="n">door</span><span class="p">,</span> <span class="n">radius_max</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># values: loss, indices: strategy</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">poisson_timings</span><span class="p">(</span><span class="n">players</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">s_our</span> <span class="ow">in</span> <span class="n">strategies</span><span class="p">:</span>
                <span class="n">loss</span><span class="p">[</span><span class="n">s_our</span><span class="p">]</span> <span class="o">+=</span> <span class="n">payoff</span><span class="p">(</span><span class="n">s_our</span><span class="p">,</span> <span class="n">strategy</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">t_aset</span><span class="p">,</span> <span class="n">t_evac</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                      <span class="n">t_evac</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">strategy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>  <span class="c1"># Update strategy</span>
        <span class="n">loss</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Reset loss array</span></div>


<div class="viewcode-block" id="EgressGame"><a class="viewcode-back" href="../../../../api/game.html#crowddynamics.plugins.game.EgressGame">[docs]</a><span class="k">class</span> <span class="nc">EgressGame</span><span class="p">(</span><span class="n">TaskNode</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Patient and impatient pedestrians in a spatial game :math:`(S, f)` for</span>
<span class="sd">    egress congestion between players :math:`P \subset A` with set of strategies </span>
<span class="sd">    :math:`S` and payoff function :math:`f : S \times S \mapsto \mathbb{R}`.</span>

<span class="sd">    Set of strategies</span>

<span class="sd">    .. math::</span>
<span class="sd">       S &amp;= \{ \text{Impatient}, \text{Patient} \} \\</span>
<span class="sd">         &amp;= \{ 0, 1 \}</span>

<span class="sd">    Payoff matrix / function</span>

<span class="sd">    .. math::</span>
<span class="sd">       f(s_i, s_j) = \left[\begin{matrix}\left ( \frac{T_{aset}}{T_{ij}}, \quad \frac{T_{aset}}{T_{ij}}\right ) &amp; \left ( -1, \quad 1\right )\\\left ( 1, \quad -1\right ) &amp; \left ( 0, \quad 0\right )\end{matrix}\right]</span>

<span class="sd">    Estimated evacuation time for an agent</span>

<span class="sd">    .. math::</span>
<span class="sd">       T_i = \frac{\lambda_i}{\beta},</span>

<span class="sd">    where</span>

<span class="sd">    - :math:`\beta` is the capacity of the exit door</span>
<span class="sd">    - :math:`\lambda_i` number of other agents closer to the exit.</span>

<span class="sd">    Average evacuation time</span>

<span class="sd">    .. math::</span>
<span class="sd">       T_{ij} = \frac{(T_i + T_j)}{2}.</span>

<span class="sd">    Effect on agents</span>

<span class="sd">    - :math:`k`</span>
<span class="sd">    - :math:`\tau_{adj}`</span>
<span class="sd">    - :math:`\sigma_{force}`</span>

<span class="sd">    References</span>

<span class="sd">    .. [game2013] Heli??vaara, S., Ehtamo, H., Helbing, D., &amp; Korhonen, T. (2013). Patient and impatient pedestrians in a spatial game for egress congestion. Physical Review E - Statistical, Nonlinear, and Soft Matter Physics. http://doi.org/10.1103/PhysRevE.87.012802</span>
<span class="sd">    .. [game2014] Von Schantz, A., &amp; Ehtamo, H. (2014). Cellular automaton evacuation model coupled with a spatial game. In Lecture Notes in Computer Science (including subseries Lecture Notes in Artificial Intelligence and Lecture Notes in Bioinformatics). http://doi.org/10.1007/978-3-319-09912-5_31</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EgressGame.__init__"><a class="viewcode-back" href="../../../../api/game.html#crowddynamics.plugins.game.EgressGame.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation</span><span class="p">,</span> <span class="n">door</span><span class="p">,</span> <span class="n">room</span><span class="p">,</span> <span class="n">t_aset_0</span><span class="p">,</span>
                 <span class="n">interval</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">neighbor_radius</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">neighborhood_size</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">        EgressGame</span>

<span class="sd">        Args:</span>
<span class="sd">            simulation: MultiAgent Simulation</span>
<span class="sd">            door:</span>
<span class="sd">            room (numpy.ndarray):</span>
<span class="sd">            t_aset_0: Initial available safe egress time.</span>
<span class="sd">            interval: Interval for updating strategies</span>
<span class="sd">            neighbor_radius:</span>
<span class="sd">            neighborhood_size:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="c1"># TODO: Not include agent that have reached their goals</span>
        <span class="c1"># TODO: check if j not in players:</span>
        <span class="c1"># TODO: Update agents parameters by the new strategy</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">simulation</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">door</span> <span class="o">=</span> <span class="n">door</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">):</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">room</span><span class="o">.</span><span class="n">exterior</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="n">room</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">room</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>  <span class="c1"># Polygon vertices</span>

        <span class="c1"># Game properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_aset_0</span> <span class="o">=</span> <span class="n">t_aset_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_aset</span> <span class="o">=</span> <span class="n">t_aset_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_evac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>

        <span class="c1"># Agent states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="c1"># Set neigbourhood</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">neighbor_radius</span> <span class="o">=</span> <span class="n">neighbor_radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">neighborhood_size</span> <span class="o">=</span> <span class="n">neighborhood_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">reset_neighbor</span><span class="p">()</span></div>

<div class="viewcode-block" id="EgressGame.parameters"><a class="viewcode-back" href="../../../../api/game.html#crowddynamics.plugins.game.EgressGame.parameters">[docs]</a>    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Parameters that can be saved or plotted.&quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;strategies&quot;</span><span class="p">,</span>
            <span class="s2">&quot;strategy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_aset_0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;t_evac&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interval&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span>  <span class="s2">&quot;</span><span class="si">{cls}</span><span class="s2"> doesn&#39;t have attribute </span><span class="si">{attr}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cls</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="EgressGame.reset"><a class="viewcode-back" href="../../../../api/game.html#crowddynamics.plugins.game.EgressGame.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Reset&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_evac</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="EgressGame.update"><a class="viewcode-back" href="../../../../api/game.html#crowddynamics.plugins.game.EgressGame.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot;Update strategies for all agents.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># Indices of agents that are playing the game</span>
        <span class="c1"># Loop over agents and update strategies</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">agent</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">active</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">room</span><span class="o">.</span><span class="n">contains_points</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">size</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># Agents that are not playing anymore will be patient again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">[</span><span class="n">mask</span> <span class="o">^</span> <span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t_aset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_aset_0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">time_tot</span>
        <span class="n">best_response_strategy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">door</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">t_aset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">dt_prev</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Jaan Tollander de Balsch.
      Last updated on Jan 24, 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>